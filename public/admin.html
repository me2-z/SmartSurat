<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin Panel - Smart Surat City Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f9ff; }
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        .table-row {
            transition: background-color 0.2s ease;
        }
        .table-row:hover {
            background-color: rgba(14, 165, 233, 0.05);
        }
        .status-pending { @apply bg-yellow-100 text-yellow-800; }
        .status-resolved { @apply bg-green-100 text-green-800; }
        .status-in-progress { @apply bg-blue-100 text-blue-800; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Top Bar -->
    <header class="bg-white shadow-sm border-b border-sky-200">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-r from-sky-500 to-sky-700 rounded-lg flex items-center justify-center mr-3">
                        <i data-feather="shield" class="text-white w-6 h-6"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-sky-900">Admin Panel</h1>
                </div>
                <button id="logoutBtn" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg flex items-center">
                    <i data-feather="log-out" class="w-4 h-4 mr-2"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-sky-900">Manage Complaints</h2>
            <p class="text-sky-700">View, update, and delete citizen complaints.</p>
        </div>

        <!-- Stats Cards -->
        <section class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-lg border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sky-700 font-medium">Total Complaints</p>
                        <p class="text-3xl font-bold text-sky-900" id="totalComplaints">0</p>
                    </div>
                    <div class="w-12 h-12 bg-sky-100 rounded-xl flex items-center justify-center">
                        <i data-feather="file-text" class="text-sky-600 w-6 h-6"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sky-700 font-medium">Pending</p>
                        <p class="text-3xl font-bold text-yellow-600" id="pendingComplaints">0</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                        <i data-feather="clock" class="text-yellow-600 w-6 h-6"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sky-700 font-medium">In Progress</p>
                        <p class="text-3xl font-bold text-blue-600" id="inProgressComplaints">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i data-feather="activity" class="text-blue-600 w-6 h-6"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sky-700 font-medium">Resolved</p>
                        <p class="text-3xl font-bold text-green-600" id="resolvedComplaints">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i data-feather="check-circle" class="text-green-600 w-6 h-6"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- Complaints Table -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-sky-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-sky-800 uppercase">ID</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-sky-800 uppercase">Title</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-sky-800 uppercase">User</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-sky-800 uppercase">Status</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-sky-800 uppercase">Time</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-sky-800 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="complaintsTable" class="divide-y divide-sky-100">
                    </tbody>
                </table>
            </div>
            <div class="p-6 bg-sky-50">
                <p id="noComplaints" class="text-center text-sky-700 py-4 hidden">No complaints found.</p>
            </div>
        </div>
    </main>

    <script>
        feather.replace();

        // Auth guard - admin only
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role !== 'admin') {
            window.location.href = 'auth.html';
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('user');
            window.location.href = 'auth.html';
        });

        // DOM elements
        const tableBody = document.getElementById("complaintsTable");
        const noComplaintsMsg = document.getElementById("noComplaints");
        const totalEl = document.getElementById("totalComplaints");
        const pendingEl = document.getElementById("pendingComplaints");
        const inProgressEl = document.getElementById("inProgressComplaints");
        const resolvedEl = document.getElementById("resolvedComplaints");

        // Fetch all complaints
        async function loadComplaints() {
            try {
                const response = await fetch('/api/complaints');
                if (!response.ok) throw new Error('Failed to load complaints');
                const complaints = await response.json();

                // Update stats
                totalEl.textContent = complaints.length;
                const pending = complaints.filter(c => c.status === 'pending').length;
                const inProgress = complaints.filter(c => c.status === 'in-progress').length;
                const resolved = complaints.filter(c => c.status === 'resolved').length;
                pendingEl.textContent = pending;
                inProgressEl.textContent = inProgress;
                resolvedEl.textContent = resolved;

                // Render table
                if (complaints.length === 0) {
                    noComplaintsMsg.classList.remove('hidden');
                    tableBody.innerHTML = '';
                } else {
                    noComplaintsMsg.classList.add('hidden');
                    tableBody.innerHTML = complaints.map(c => {
                        let statusClass = 'status-pending';
                        let displayStatus = 'Pending';
                        if (c.status === 'resolved') {
                            statusClass = 'status-resolved';
                            displayStatus = 'Resolved';
                        } else if (c.status === 'in-progress') {
                            statusClass = 'status-in-progress';
                            displayStatus = 'In Progress';
                        }

                        return `
                            <tr class="table-row">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-sky-900">${c.id}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-sky-800">
                                    <a href="complaint-detail.html?id=${c.id}" class="text-sky-600 hover:underline">${c.title}</a>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-sky-700">${c.userName || 'Unknown'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <select class="status-select px-2 py-1 border rounded text-xs ${statusClass}" data-id="${c.id}">
                                        <option value="pending" ${c.status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="in-progress" ${c.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="resolved" ${c.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                    </select>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-sky-700">
                                    ${new Date(c.createdAt).toLocaleString()}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <button class="delete-btn text-red-600 hover:text-red-800 mr-3" data-id="${c.id}">
                                        <i data-feather="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    feather.replace();

                    // Add event listeners
                    document.querySelectorAll('.status-select').forEach(select => {
                        select.addEventListener('change', updateComplaintStatus);
                    });
                    document.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', deleteComplaint);
                    });
                }
            } catch (error) {
                noComplaintsMsg.textContent = 'Failed to load complaints.';
                noComplaintsMsg.classList.remove('hidden');
                tableBody.innerHTML = '';
            }
        }

        // Update complaint status
        async function updateComplaintStatus(e) {
            const complaintId = e.target.dataset.id;
            const newStatus = e.target.value;
            
            try {
                const response = await fetch(`/api/complaints/${complaintId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    loadComplaints(); // Refresh
                } else {
                    alert('Failed to update status');
                    e.target.value = 'pending';
                }
            } catch (error) {
                alert('Network error. Please try again.');
                e.target.value = 'pending';
            }
        }

        // Delete complaint
        async function deleteComplaint(e) {
            if (!confirm('Delete this complaint?')) return;
            
            const complaintId = e.target.closest('button').dataset.id;
            
            try {
                const response = await fetch(`/api/complaints/${complaintId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadComplaints(); // Refresh
                } else {
                    alert('Failed to delete complaint');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }

        // Load data on page load
        loadComplaints();
    </script>
</body>
</html>